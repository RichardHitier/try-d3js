<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <style>

    svg {
      background-color: #f2f2f2;
      border: 1pt solid black;
    }

    rect {
      fill: #f2f2f2;
      stroke-width: 1pt;
    }

    rect.hover {
      stroke: black;
      fill: white;
    }

    rect.velo {
      stroke: darkblue;
    }

    rect.rando {
      stroke: brown;
    }

    #tooltip {
      padding: 0.5em;
      position: absolute;
      border: solid black 1pt;
    }

    #tooltip.velo {
      background-color: lightsteelblue;
    }

    #tooltip.rando {
      background-color: lightpink;
    }
  </style>

</head>
<body>


  <!-- Create a div where the circles will take place -->
  <div id="chart_cyclo_bar"></div>

  <!-- Load d3.js -->
  <script src="https://d3js.org/d3.v6.min.js"></script>

  <script>
    var margin = {'top': 40, 'right': 10, 'bottom': 140, 'left': 120},
        width = 1800 - margin.left - margin.right,
        height = 400 - margin.top - margin.bottom;

    const x = d3.scaleTime()
        .range([5, 15])

    const y = d3.scaleLinear()
        .range([height, 0])

    var svg = d3.select('#chart_cyclo_bar')
        .append('svg')
        .attr('id', 'svg')
        .attr('width', width + margin.right + margin.left)
        .attr('height', height + margin.top + margin.bottom)
        .append('g')
        .attr('transform', 'translate(' + margin.left + ',' + margin.top + ')');

    // var	parseDate = d3.time.format("%Y-%m").parse;
    const tooltip = d3.select("body").append("div")
        .attr("id", "tooltip")
        .style("opacity", 0);

    d3.csv("./cyclo.csv").then(data => {
      console.log(data);
      data.forEach(function (d) {
        d.date = new Date(d.date)
        d.distance = +d.distance;
      });

      x.domain(data.map(d => d.date))
      y.domain([0, d3.max(data, d => d.distance)])

      svg.append("g")
          .attr('transform', 'translate(0,' + height + ')')
          .call(d3.axisBottom(x).tickSize(5))
          .selectAll("text")
          .style("text-anchor", 'end')
          .attr("dx", "-.8em")
          .attr("dy", ".15em")
          .attr("transform", "rotate(-65)");

      svg.append("g")
          .call(d3.axisLeft(y).ticks(1))

      svg.selectAll(".bar")
          .data(data)
          .enter().append("rect")
          .attr("class", d => d.mode)
          .attr("x", d => x(d.date))
          .attr("width", 7)
          .attr("y", d => y(d.distance))
          .attr("height", d => height - y(d.distance))
          .on("mouseover", function (e, d) {
            d3.select(this).attr("class", "hover")
            tooltip.attr("class", d.mode);
            tooltip.transition()
                .duration(200)
                .style("opacity", .9);
            tooltip.html("<b>" + d.nom + "</b><br>distance : " + d.distance + " km<br>durÃ©e: " + d.temps)
                .style("left", (e.pageX + 0) + "px")
                .style("top", margin.top + "px");
            // .style("top", (e.pageY - 200) + "px");
          })
          // .on("mousemove", function (e, d) {
          //   tooltip
          //       .style("left", (e.pageX + 0) + "px")
          //       .style("top", (e.pageY - 200) + "px");
          // })
          .on("mouseout", function (d) {
            d3.select(this).attr("class", d=>d.mode);
            tooltip.transition()
                .duration(500)
                .style("opacity", 0);
          });
    });


  </script>
</body>
